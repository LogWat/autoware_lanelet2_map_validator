# This file is automatically synced from:
# https://github.com/autowarefoundation/sync-file-templates
# To make changes, update the source repository and follow the guidelines in its README.

name: github-release

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:
    inputs:
      tag-name:
        description: The name of the tag to release
        type: string
        required: true

jobs:
  # Build and package the binaries
  # This job builds the package and creates a zip file containing the built artifacts.
  build-and-package:
    runs-on: ubuntu-22.04
    container: ghcr.io/autowarefoundation/autoware:core-devel
    steps:
      # ref: build-and-test.yaml
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Remove exec_depend
        uses: autowarefoundation/autoware-github-actions/remove-exec-depend@v1

      - name: Get self packages
        id: get-self-packages
        uses: autowarefoundation/autoware-github-actions/get-self-packages@v1

      - name: Build
        if: ${{ steps.get-self-packages.outputs.self-packages != '' }}
        uses: autowarefoundation/autoware-github-actions/colcon-build@v1
        with:
          rosdistro: humble
          target-packages: ${{ steps.get-self-packages.outputs.self-packages }}
          build-depends-repos: build_depends.repos

      - name: Package artifacts
        run: |
          VERSION=${{ github.ref_name }}
          zip -r autoware_lanelet2_map_validator-${VERSION#v}-ubuntu-22.04.zip install
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: autoware_lanelet2_map_validator-artifact
          path: autoware_lanelet2_map_validator-*.zip

  github-release:
    runs-on: ubuntu-22.04
    needs: build-and-package
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: autoware_lanelet2_map_validator-artifact

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: autoware_lanelet2_map_validator-*.zip
        draft: true
        generate_release_notes: true
