jobs:
  # Build and package the binaries
  build-and-package:
    runs-on: ubuntu-22.04
    container: ghcr.io/autowarefoundation/autoware:core-devel
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install zip utility
        run: |
          apt-get update
          apt-get install -y zip

      - name: Remove exec_depend
        uses: autowarefoundation/autoware-github-actions/remove-exec-depend@v1

      - name: Get self packages
        id: get-self-packages
        uses: autowarefoundation/autoware-github-actions/get-self-packages@v1

      - name: Build
        if: ${{ steps.get-self-packages.outputs.self-packages != '' }}
        uses: autowarefoundation/autoware-github-actions/colcon-build@v1
        with:
          rosdistro: humble
          target-packages: ${{ steps.get-self-packages.outputs.self-packages }}

      - name: Package artifacts
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REF_NAME="${{ github.event.inputs.tag-name }}"
          else
            REF_NAME="${{ github.ref_name }}"
          fi
          VERSION=${REF_NAME#v}
          zip -r autoware_lanelet2_map_validator-${VERSION}-ubuntu-22.04.zip install
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: autoware_lanelet2_map_validator-artifact
          path: autoware_lanelet2_map_validator-*.zip